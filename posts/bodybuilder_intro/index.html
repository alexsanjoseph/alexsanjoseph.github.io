<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.76.5" />

    
    
    

<title>Bodybuilder - A python port of the nodeJS BodyBuilder Package • Alex&#39;s Blog</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Bodybuilder - A python port of the nodeJS BodyBuilder Package"/>
<meta name="twitter:description" content="At VIMANA, we have an Elasticsearch backend for storing most of our Big Data. While Elasticsearch is an amazing search engine which can do a variety of queries/aggregations, the Elasticsearch Query DSL is difficult to construct, especialy for newcomers. I have spent countless hours trying to get the brackets right and the searching for the specific terms. While the new SQL options allows the user to query using SQL, that still doesn&rsquo;t have all the capabilities supported by the full DSL."/>

<meta property="og:title" content="Bodybuilder - A python port of the nodeJS BodyBuilder Package" />
<meta property="og:description" content="At VIMANA, we have an Elasticsearch backend for storing most of our Big Data. While Elasticsearch is an amazing search engine which can do a variety of queries/aggregations, the Elasticsearch Query DSL is difficult to construct, especialy for newcomers. I have spent countless hours trying to get the brackets right and the searching for the specific terms. While the new SQL options allows the user to query using SQL, that still doesn&rsquo;t have all the capabilities supported by the full DSL." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/bodybuilder_intro/" />
<meta property="article:published_time" content="2020-10-18T20:39:10+05:30" />
<meta property="article:modified_time" content="2020-10-18T20:39:10+05:30" /><meta property="og:site_name" content="Alex&#39;s Blog" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.610b92ad1570efec97005d6bca989ded138fab720d6d49c2753307a69ca8b7d6.css" integrity="sha256-YQuSrRVw7&#43;yXAF1rypid7ROPq3INbUnCdTMHppyot9Y=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="/">Alex&#39;s Blog</a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="/img/alex.jpeg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Alex&#39;s Blog</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/alexsanjoseph" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/alexsanjoseph" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/alexsanjoseph" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/1653808/alex-joseph" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:alexsanjoseph%20at%20gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2016 - 2020 alexsanjoseph
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Bodybuilder - A python port of the nodeJS BodyBuilder Package</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020 Oct 18
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  <div class="post">
    <p>At VIMANA, we have an Elasticsearch backend for storing most of our Big Data. While Elasticsearch is an amazing search engine which can do a variety of queries/aggregations, the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Elasticsearch Query DSL</a> is difficult to construct, especialy for newcomers. I have spent countless hours trying to get the brackets right and the searching for the specific terms. While the new SQL options allows the user to query using SQL, that still doesn&rsquo;t have all the capabilities supported by the full DSL.</p>
<p>We NodeJS in the backend to query ES. However, construct the query in JS is quite simple thanks to the amazing <a href="https://github.com/danpaz/bodybuilder">Elasticsearch Bodybuilder Package on NPM</a>. This allow the user to make a query like this -</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">bodybuilder</span>()
        .<span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#39;match&#39;</span>, <span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#e6db74">&#39;this is a test&#39;</span>)
        .<span style="color:#a6e22e">filter</span>(<span style="color:#e6db74">&#39;term&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;kimchy&#39;</span>)
        .<span style="color:#a6e22e">orFilter</span>(<span style="color:#e6db74">&#39;term&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;johnny&#39;</span>)
        .<span style="color:#a6e22e">notFilter</span>(<span style="color:#e6db74">&#39;term&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;cassie&#39;</span>)
        .<span style="color:#a6e22e">aggregation</span>(<span style="color:#e6db74">&#39;terms&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>)
        .<span style="color:#a6e22e">build</span>()
</code></pre></div><p>which is converted into the admittedly complex query below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;query&#34;</span>: {
    <span style="color:#f92672">&#34;bool&#34;</span>: {
      <span style="color:#f92672">&#34;filter&#34;</span>: {
        <span style="color:#f92672">&#34;bool&#34;</span>: {
          <span style="color:#f92672">&#34;must&#34;</span>: {
            <span style="color:#f92672">&#34;term&#34;</span>: {
              <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;kimchy&#34;</span>
            }
          },
          <span style="color:#f92672">&#34;should&#34;</span>: [
            {
              <span style="color:#f92672">&#34;term&#34;</span>: {
                <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;johnny&#34;</span>
              }
            }
          ],
          <span style="color:#f92672">&#34;must_not&#34;</span>: [
            {
              <span style="color:#f92672">&#34;term&#34;</span>: {
                <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;cassie&#34;</span>
              }
            }
          ]
        }
      },
      <span style="color:#f92672">&#34;must&#34;</span>: {
        <span style="color:#f92672">&#34;match&#34;</span>: {
          <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;this is a test&#34;</span>
        }
      }
    }
  },
  <span style="color:#f92672">&#34;aggs&#34;</span>: {
    <span style="color:#f92672">&#34;agg_terms_user&#34;</span>: {
      <span style="color:#f92672">&#34;terms&#34;</span>: {
        <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>
      }
    }
  }
}
</code></pre></div><p>When we wanted to build some of our apps in Python, however, there was no readymade package available to be able to construct queries in a similar manner as above. Hence bodybuilder(python) was born!</p>
<p>Bodybuilder is envisioned as an (almost!) drop in replacement in python of the original Node Package. The API has been designed to be as close to the original package. Continuing the example above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> bodybuilder <span style="color:#f92672">import</span> BodyBuilder <span style="color:#66d9ef">as</span> bodyBuilder
<span style="color:#f92672">import</span> json

output <span style="color:#f92672">=</span> bodybuilder() \
        <span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;match&#39;</span>, <span style="color:#e6db74">&#39;message&#39;</span>, <span style="color:#e6db74">&#39;this is a test&#39;</span>) \
        <span style="color:#f92672">.</span>filter(<span style="color:#e6db74">&#39;term&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;kimchy&#39;</span>) \
        <span style="color:#f92672">.</span>orFilter(<span style="color:#e6db74">&#39;term&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;johnny&#39;</span>) \
        <span style="color:#f92672">.</span>notFilter(<span style="color:#e6db74">&#39;term&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>, <span style="color:#e6db74">&#39;cassie&#39;</span>) \
        <span style="color:#f92672">.</span>aggregation(<span style="color:#e6db74">&#39;terms&#39;</span>, <span style="color:#e6db74">&#39;user&#39;</span>) \
        <span style="color:#f92672">.</span>build()
<span style="color:#66d9ef">print</span>(json<span style="color:#f92672">.</span>dumps(output, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, sort_keys<span style="color:#f92672">=</span>True))

</code></pre></div><p>Gives the result as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;aggs&#34;</span>: {
        <span style="color:#f92672">&#34;agg_terms_user&#34;</span>: {
            <span style="color:#f92672">&#34;terms&#34;</span>: {
                <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>
            }
        }
    },
    <span style="color:#f92672">&#34;query&#34;</span>: {
        <span style="color:#f92672">&#34;bool&#34;</span>: {
            <span style="color:#f92672">&#34;filter&#34;</span>: {
                <span style="color:#f92672">&#34;term&#34;</span>: {
                    <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;kimchy&#34;</span>
                }
            },
            <span style="color:#f92672">&#34;must&#34;</span>: {
                <span style="color:#f92672">&#34;match&#34;</span>: {
                    <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;this is a test&#34;</span>
                }
            },
            <span style="color:#f92672">&#34;must_not&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;term&#34;</span>: {
                        <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;cassie&#34;</span>
                    }
                }
            ],
            <span style="color:#f92672">&#34;should&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;term&#34;</span>: {
                        <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;johnny&#34;</span>
                    }
                }
            ]
        }
    }
}
</code></pre></div><p>The two queries are semantically equivalent.</p>
<h1 id="test-it-out">Test it out!</h1>
<p>Installation instructions and variations from the original package can be found on the <a href="https://github.com/alexsanjoseph/bodybuilder">project home page</a></p>
<p>You can use <a href="https://bodybuilder.js.org/">https://bodybuilder.js.org/</a> to test your constructions</p>
<h1 id="credits">Credits</h1>
<p>Thanks to <a href="https://github.com/danpaz">Danpaz</a> and <a href="https://github.com/danpaz/bodybuilder#contributors">contributors of the original package</a> for the original package from which I have liberally copied (with his permission!)</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/posts/comparedf-intro/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Introducing compareDF</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-179464703-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
